stages:
  - test
  - build

test:
  image: registry.gitlab.com/bagage/cadastre-conflation/ci-test
  stage: test
  cache:
    untracked: true
    paths:
      - cache-ci/
  before_script:
    - yarn config set cache-folder cache-ci
  script:
    - cd frontend/
    - yarn
    - yarn lint
    - yarn prettier --check
    - yarn test --karma-config src/karma-ci.conf.js
  except:
    - master

.build_docker_image: &build_docker_image
  image: docker:stable
  services:
    - docker:dind
  stage: build
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
  only:
    - master
  script:
    - docker build -t registry.gitlab.com/bagage/cadastre-conflation/$CONTAINER:$CI_COMMIT_REF_SLUG -f ${BASE_DIR:-$CONTAINER}/$DOCKERFILE ${BASE_DIR:-$CONTAINER}
    - docker tag registry.gitlab.com/bagage/cadastre-conflation/$CONTAINER:$CI_COMMIT_REF_SLUG registry.gitlab.com/bagage/cadastre-conflation/$CONTAINER:latest
    - docker push registry.gitlab.com/bagage/cadastre-conflation/$CONTAINER:latest
    - docker push registry.gitlab.com/bagage/cadastre-conflation/$CONTAINER:$CI_COMMIT_REF_SLUG
  retry: 2

build_ci_test:
  <<: *build_docker_image
  variables:
    CONTAINER: ci-test
    DOCKERFILE: Dockerfile.ci
    BASE_DIR: frontend

build_tiles_cleaner:
  <<: *build_docker_image
  variables:
    CONTAINER: tiles-cleaner
    DOCKERFILE: Dockerfile

build_postgis:
  <<: *build_docker_image
  variables:
    CONTAINER: postgis
    DOCKERFILE: Dockerfile

build_imposm:
  <<: *build_docker_image
  variables:
    CONTAINER: imposm
    DOCKERFILE: Dockerfile

build_initdb_worker:
  <<: *build_docker_image
  variables:
    CONTAINER: initdb_worker
    DOCKERFILE: Dockerfile

build_backend:
  <<: *build_docker_image
  variables:
    CONTAINER: backend
    DOCKERFILE: Dockerfile

build_tiles:
  <<: *build_docker_image
  variables:
    CONTAINER: tiles
    DOCKERFILE: Dockerfile

build_frontend:
  <<: *build_docker_image
  variables:
    CONTAINER: frontend
    DOCKERFILE: Dockerfile.prod
