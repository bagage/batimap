[webserver]
port = ":9999"

[cache]
type = "file"
max_zoom = 17
basepath = "/app/data/cache"

# register data providers
[[providers]]
name = "cadastre"       # provider name is referenced from map layers
type = "postgis"        # the type of data provider. currently only supports postgis
host = "postgis"        # postgis database host
port = 5432             # postgis database port
database = "gis"        # postgis database name
user = "docker"       # postgis database user
password = "batimap"    # postgis database password
srid = 4326             # The default srid for this provider. If not provided it will be WebMercator (3857)

[[providers.layers]]
name = "cities"
geometry_fieldname = "way"
id_fieldname = "osm_id"
sql = """
  SELECT
    ST_AsBinary(way) AS way,
    c.name,
    c.details,
    insee,
    date,
    case when date_cadastre is null then '' else 'true' end as josm_ready,
    osm_id
  FROM
    planet_osm_polygon, city_stats c
  WHERE
    admin_level::int >= '8'
    AND c.insee = "ref:INSEE"
    AND "ref:INSEE" = insee
    AND way && !BBOX!
"""

[[providers.layers]]
name = "cities-point"
geometry_fieldname = "way"
id_fieldname = "osm_id"
sql = """
  SELECT
    ST_AsBinary(ST_Centroid(way)) AS way,
    c.name,
    c.details,
    insee,
    date,
    case when date_cadastre is null then '' else 'true' end as josm_ready,
    osm_id
  FROM
    planet_osm_polygon,
    city_stats c
  WHERE
    admin_level::int >= '8'
    AND c.insee = "ref:INSEE"
    AND "ref:INSEE" = insee
    AND way && !BBOX!
"""

[[providers.layers]]
name = "departments"
geometry_fieldname = "way"
id_fieldname = "osm_id"
sql = """
  WITH view_department_stats AS (
    SELECT DISTINCT ON (department)
      department,
      date
    FROM
      city_stats
    GROUP BY
      department,
      date
    ORDER BY
      department,
      COUNT(date) DESC
  )
  SELECT
    ST_AsBinary(way) AS way,
    date,
    p.name,
    "ref:INSEE" AS insee,
    osm_id
  FROM
    planet_osm_polygon p,
    view_department_stats
  WHERE
    admin_level = '6'
    AND "ref:INSEE" LIKE department || '%'
    AND way && !BBOX!
"""

[[maps]]
name = "batimap"
[[maps.layers]]
provider_layer = "cadastre.cities"
min_zoom = 9
max_zoom = 13

[[maps.layers]]
provider_layer = "cadastre.cities-point"
min_zoom = 8
max_zoom = 8

[[maps.layers]]
provider_layer = "cadastre.departments"
min_zoom = 0
max_zoom = 7
